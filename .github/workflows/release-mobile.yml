name: Mobile Release

on:
  push:
    tags:
      - 'mobile-v*'

permissions:
  contents: write

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile

    steps:
      - name: ðŸ—ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ˜ Setup Gradle Build Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/build-cache
            mobile/android/.gradle
            mobile/android/app/build/intermediates
            mobile/android/app/build/generated
          key: ${{ runner.os }}-gradle-${{ hashFiles('mobile/android/**/*.gradle*', 'mobile/android/gradle-wrapper.properties', 'mobile/app.json') }}
          restore-keys: |
            ${{ runner.os }}-gradle-${{ hashFiles('mobile/android/**/*.gradle*', 'mobile/android/gradle-wrapper.properties') }}
            ${{ runner.os }}-gradle-

      - name: ðŸ“¦ Setup Bun Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            mobile/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('mobile/bun.lock', 'mobile/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-${{ hashFiles('mobile/bun.lock') }}
            ${{ runner.os }}-bun-

      - name: ðŸš‡ Setup Metro Cache
        uses: actions/cache@v4
        with:
          path: mobile/node_modules/.cache
          key: ${{ runner.os }}-metro-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-metro-

      - name: ðŸ“¦ Install dependencies
        run: bun install

      - name: ðŸš€ Install EAS CLI
        run: npm install -g eas-cli

      - name: ðŸ·ï¸ Extract version from tag
        id: version
        run: |
          # Extract version from tag (mobile-v1.1.4 -> 1.1.4)
          VERSION=${GITHUB_REF#refs/tags/mobile-v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: ðŸ”¨ Prebuild Android
        run: |
          cd mobile
          # Generate native Android code (can be cached)
          bunx expo prebuild --platform android --clean

      - name: ðŸ“± Build APK
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          ORG_GRADLE_PROJECT_android.enableJetifier: true
          ORG_GRADLE_PROJECT_android.useAndroidX: true
          ORG_GRADLE_PROJECT_org.gradle.caching: true
          ORG_GRADLE_PROJECT_org.gradle.parallel: true
          ORG_GRADLE_PROJECT_org.gradle.daemon: false
          ORG_GRADLE_PROJECT_org.gradle.configureondemand: true
        run: |
          # Increase Gradle memory for CI
          export GRADLE_OPTS="-Xmx6g -XX:MaxMetaspaceSize=2g -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.jvmargs='-Xmx6g -XX:MaxMetaspaceSize=2g'"
          
          # Build without lint checks to save memory
          eas build \
            --platform android \
            --profile production-ci \
            --local \
            --non-interactive \
            --output selfTracker-${{ steps.version.outputs.version }}.apk

      - name: ðŸ“¤ Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: mobile/selfTracker-${{ steps.version.outputs.version }}.apk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
