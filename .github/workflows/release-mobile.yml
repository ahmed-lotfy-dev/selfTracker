name: Mobile Release

on:
  push:
    tags:
      - 'mobile-v*'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile

    steps:
      - name: üèóÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: üêò Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('mobile/**/*.gradle*', 'mobile/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: üì¶ Setup Bun Cache
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: üöá Setup Metro Cache
        uses: actions/cache@v4
        with:
          path: mobile/node_modules/.cache
          key: ${{ runner.os }}-metro-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-metro-

      - name: üì¶ Install dependencies
        run: bun install

      - name: üöÄ Install EAS CLI
        run: npm install -g eas-cli

      - name: üì± Build APK
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          ORG_GRADLE_PROJECT_android.enableJetifier: true
          ORG_GRADLE_PROJECT_android.useAndroidX: true
          ORG_GRADLE_PROJECT_org.gradle.caching: true
          ORG_GRADLE_PROJECT_org.gradle.parallel: true
          ORG_GRADLE_PROJECT_org.gradle.daemon: false
          ORG_GRADLE_PROJECT_org.gradle.configureondemand: true
        run: |
          # Increase Gradle memory for CI
          export GRADLE_OPTS="-Xmx6g -XX:MaxMetaspaceSize=2g -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.jvmargs='-Xmx6g -XX:MaxMetaspaceSize=2g'"
          
          # Build without lint checks to save memory
          eas build \
            --platform android \
            --profile production \
            --local \
            --non-interactive \
            --output selfTracker.apk

      - name: üì§ Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: mobile/selfTracker.apk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
